<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2K SYNC - STADIUM ENTRANCE</title>
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&display=swap');
        * { box-sizing: border-box; }
        :root { --red: #ff0000; --glow: 0 0 10px rgba(255, 0, 0, 0.5); }
        
        body { 
            margin: 0; font-family: 'Inter', sans-serif; background: #000; color: white; 
            display: flex; justify-content: center; min-height: 100vh; padding: 5px; 
            background: radial-gradient(circle at top, #1a0000 0%, #000 100%);
            background-attachment: fixed;
            overflow-x: hidden; width: 100%;
            position: relative;
        }

        /* FOCOS REALISTAS DE PABELL√ìN */
        body::before, body::after {
            content: ''; position: fixed; top: -100px; 
            width: 600px; height: 150vh;
            z-index: -1; pointer-events: none;
            background: linear-gradient(180deg, rgba(255, 0, 0, 0.5) 0%, transparent 90%);
            /* Forma de haz: estrecho arriba (45-55%) y ancho abajo (0-100%) */
            clip-path: polygon(48% 0%, 52% 0%, 100% 100%, 0% 100%);
            filter: blur(40px);
            opacity: 0.15;
            transform-origin: top center;
        }
        body::before {
            left: 0;
            animation: sweepSpot1 8s infinite alternate ease-in-out;
        }
        body::after {
            right: 0;
            animation: sweepSpot2 10s infinite alternate-reverse ease-in-out;
        }

        @keyframes sweepSpot1 {
            0% { transform: rotate(-30deg); opacity: 0.1; }
            100% { transform: rotate(-5deg); opacity: 0.25; }
        }
        @keyframes sweepSpot2 {
            0% { transform: rotate(5deg); opacity: 0.1; }
            100% { transform: rotate(30deg); opacity: 0.25; }
        }

        .app { width: 100%; max-width: 1000px; position: relative; }
        h1 { font-family: 'Orbitron'; color: var(--red); text-align: center; text-shadow: var(--glow); letter-spacing: 2px; margin: 10px 0; font-size: 1.4rem; }

        /* FOCOS BLANCOS COMPLEMENTARIOS - OPTIMIZADOS */
        .spotlight { 
            position: fixed; top: -200px; 
            width: 600px; height: 160vh;
            z-index: -1; pointer-events: none;
            /* Blanco m√°s puro y potente */
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.4) 0%, transparent 80%);
            clip-path: polygon(45% 0%, 55% 0%, 100% 100%, 0% 100%);
            filter: blur(35px);
            transform-origin: top center;
            opacity: 0;
            will-change: transform, opacity;
        }
        
        #foco-L { left: 15%; animation: idleWhiteL 12s infinite alternate ease-in-out; }
        #foco-R { right: 15%; animation: idleWhiteR 15s infinite alternate-reverse ease-in-out; }

        @keyframes idleWhiteL { 
            0% { transform: rotate(-25deg) scale(0.9); opacity: 0.05; } 
            100% { transform: rotate(5deg) scale(1.1); opacity: 0.25; } 
        }
        @keyframes idleWhiteR { 
            0% { transform: rotate(25deg) scale(0.9); opacity: 0.05; } 
            100% { transform: rotate(-5deg) scale(1.1); opacity: 0.25; } 
        }

        .anim-L { animation: sweepL 1.2s ease-in-out !important; z-index: 100 !important; }
        .anim-R { animation: sweepR 1.2s ease-in-out !important; z-index: 100 !important; }
        
        @keyframes sweepL { 0% { left: -50%; opacity: 0; transform: rotate(-30deg); } 50% { opacity: 0.8; } 100% { left: 120%; opacity: 0; transform: rotate(30deg); } }
        @keyframes sweepR { 0% { right: -50%; opacity: 0; transform: rotate(30deg); } 50% { opacity: 0.8; } 100% { right: 120%; opacity: 0; transform: rotate(-30deg); } }

        /* LAYOUT */
        .main-layout { display: grid; gap: 10px; grid-template-columns: 100%; width: 100%; }
        @media (min-width: 800px) { .main-layout { grid-template-columns: 320px 1fr; } }
        .panel { background: rgba(10, 10, 10, 0.95); border: 1px solid rgba(255,0,0,0.2); border-radius: 10px; padding: 12px; width: 100%; }

        .grid { display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 4px !important; margin-bottom: 12px; }
        .chip { background: #111; border: 1px solid #333; padding: 10px 2px; border-radius: 6px; font-size: 0.6rem; font-weight: 700; color: #999; text-align: center; cursor: pointer; }
        .chip.active { border-color: var(--red); color: white; box-shadow: var(--glow); background: rgba(255,0,0,0.1); }

        .row { display: flex !important; align-items: center; justify-content: space-between; background: #080808; padding: 6px 10px; border-radius: 8px; border: 1px solid #1a1a1a; margin-bottom: 6px; }
        .p-name { font-weight: 700; font-size: 0.65rem; width: 60px; color: #eee; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .btns { display: flex; gap: 3px; }
        .box { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-weight: 800; border-radius: 4px; background: #1a1a1a; border: 1px solid #444; color: #888; cursor: pointer; }
        .box.on { background: var(--red); color: white; border-color: var(--red); }

        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input { flex: 1; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 6px; font-size: 0.85rem; }
        button { background: var(--red); color: white; border: none; padding: 12px; border-radius: 6px; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; transition: all 0.2s; }
        button:hover { background: #ff3333; transform: translateY(-1px); box-shadow: var(--glow); }
        button:active { transform: translateY(0); }

        .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid #555; color: #eee; font-size: 0.65rem; }
        .btn-secondary:hover { border-color: var(--red); color: white; background: rgba(255,0,0,0.1); }
        
        .btn-full { width: 100%; margin-top: 5px; }
        
        /* RESULTADO Y ANIMACI√ìN INDIVIDUAL */
        #final-result { min-height: 180px; margin-top: 10px; }
        .skeleton { border: 1px dashed #333; border-radius: 10px; height: 180px; display: flex; align-items: center; justify-content: center; color: #555; font-family: 'Orbitron'; font-size: 0.6rem; letter-spacing: 2px; }
        
        .result { padding: 12px; border-radius: 10px; border: 2px solid var(--red); background: rgba(255,0,0,0.1); width: 100%; }
        
        /* Animaci√≥n para cada l√≠nea */
        .res-line { 
            display: flex; justify-content: space-between; padding: 8px 0; 
            border-bottom: 1px solid rgba(255,0,0,0.1);
            opacity: 0;
            animation: fadeInRight 0.5s ease-out forwards;
        }
        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .res-pos { color: var(--red); font-family: 'Orbitron'; font-size: 0.7rem; }
        .res-val { font-weight: 700; font-size: 0.95rem; }
        .res-actions { margin-top: 15px; display: flex; gap: 8px; border-top: 1px solid rgba(255,0,0,0.1); padding-top: 12px; }
        .btn-copy { background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; flex: 1; font-size: 0.65rem; padding: 8px; }
        .btn-copy:hover { background: #128C7E; transform: translateY(-1px); box-shadow: 0 0 10px rgba(37, 211, 102, 0.4); }
        .hidden { display: none !important; }

        /* TOAST NOTIFICATIONS */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: rgba(10, 10, 10, 0.9); border-left: 4px solid var(--red); color: white; 
            padding: 15px 25px; border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 0.8rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            opacity: 0; transform: translateX(50px); animation: toastIn 0.3s ease forwards;
            pointer-events: auto; min-width: 250px; display: flex; align-items: center; justify-content: space-between;
        }
        @keyframes toastIn { to { opacity: 1; transform: translateX(0); } }
        .toast.out { animation: toastOut 0.3s ease forwards; }
        @keyframes toastOut { to { opacity: 0; transform: translateX(50px); } }
        .toast-close { cursor: pointer; color: #555; font-size: 1.2rem; margin-left: 15px; }
        .toast-close:hover { color: var(--red); }
    </style>
</head>
<body>

<div class="spotlight" id="foco-L"></div>
<div class="spotlight" id="foco-R"></div>
<div id="toast-container"></div>

<div class="app">
    <h1>2K SYNC</h1>
    <div id="view-init" class="panel" style="max-width: 360px; margin: 0 auto;">
        <button class="btn-full" onclick="startHost()">CREAR SALA</button>
        <div style="margin-top: 15px; border-top: 1px solid #222; padding-top: 15px;">
            <input type="text" id="guestNameInput" placeholder="Tu nombre..." style="margin-bottom: 5px; width: 100%;">
            <div class="input-group">
                <input type="text" id="roomIdInput" placeholder="ID SALA...">
                <button onclick="joinRoom()" class="btn-secondary">UNIRSE</button>
            </div>
        </div>
    </div>

    <div id="view-main" class="hidden">
        <div class="main-layout">
            <div class="panel">
                <div id="host-controls" class="hidden">
                    <div id="share-card" style="background:#0a0a0a; border:1px solid var(--red); border-radius:6px; padding:8px; text-align:center; cursor:pointer; margin-bottom:5px;" onclick="copyId()">
                        <span style="font-size:0.55rem; color:#aaa; display:block; text-transform: uppercase;">ID SALA (COPIAR)</span>
                        <div id="room-id-val" style="font-family:'Orbitron'; font-size:0.8rem;">-------</div>
                    </div>
                    <button class="btn-full btn-secondary" style="font-size: 0.6rem; padding: 6px; margin-bottom: 10px;" onclick="copyInviteLink()">
                        üîó COPIAR LINK DE INVITACI√ìN
                    </button>
                    <div class="input-group">
                        <input type="text" id="newPlayerName" placeholder="Nombre...">
                        <button onclick="addNewPlayer()">ADD</button>
                    </div>
                </div>
                <div class="grid" id="players-grid">
                    <div class="chip" id="c-Airam" onclick="togP('Airam')">AIRAM</div>
                    <div class="chip" id="c-Pocho" onclick="togP('Pocho')">POCHO</div>
                    <div class="chip" id="c-Isra" onclick="togP('Isra')">ISRA</div>
                    <div class="chip" id="c-Messi" onclick="togP('Messi')">MESSI</div>
                    <div class="chip" id="c-Triodo" onclick="togP('Triodo')">TRIODO</div>
                    <div class="chip" id="c-Salva" onclick="togP('Salva')">SALVA</div>
                    <div class="chip" id="c-Eu" onclick="togP('Eu')">EU</div>
                    <div class="chip" id="c-Fer" onclick="togP('Fer')">FER</div>
                </div>
                <div id="host-actions" class="hidden">
                    <button class="btn-full" onclick="preRoll()">GENERAR QUINTETO</button>
                    <button class="btn-full btn-secondary" onclick="resetAll()">REINICIAR</button>
                </div>
                <button id="guest-back" class="btn-full btn-secondary hidden" style="margin-top:10px;" onclick="location.reload()">‚Üê SALIR</button>
            </div>

            <div class="panel" id="sync-area">
                <h2 style="font-family:'Orbitron'; font-size:0.6rem; color:#888; margin:0 0 10px 0; border-bottom:1px solid #111; padding-bottom:5px; display:flex; justify-content:space-between;">
                    SALA DE SORTEO
                    <span id="conn-status" style="color: #666; font-size: 0.5rem; text-align: right;">DISPONIBLE</span>
                </h2>
                <div id="config-list"></div>
                <div id="final-result">
                    <div class="skeleton">ESPERANDO SORTEO...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCGjel1KXDgVFSYyxphSP5E2BHNdLC18KM",
        authDomain: "team-generator-sync.firebaseapp.com",
        databaseURL: "https://team-generator-sync-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "team-generator-sync",
        storageBucket: "team-generator-sync.firebasestorage.app",
        messagingSenderId: "612505072793",
        appId: "1:612505072793:web:1fdef2db8e980e4d693408",
        measurementId: "G-ENBLMFF37L"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let sel = {}, isHost = false, lastData = "", roomRef = null, myGuestRef = null;
    let lastGuestNames = []; // Para detectar nuevos invitados
    const POS_LABELS = ["PG", "SG", "LK", "PF", "C"];
    const sonidoMeme = new Audio('oh-my-god-meme.mp3');
    const sonidoEntrada = new Audio('soy-concha-entro.mp3');

    // Funci√≥n de sincronizaci√≥n eficiente (solo se llama cuando algo cambia)
    function syncHostData(effect = false) {
        if(!isHost || !roomRef) return;
        const currentGrid = document.getElementById('players-grid').innerHTML;
        const currentSync = document.getElementById('sync-area').innerHTML;
        const dataString = currentGrid + currentSync;

        // Evitar escrituras redundantes
        if (dataString !== lastData || effect) {
            roomRef.child('hostData').set({
                grid: currentGrid,
                sync: currentSync,
                effect: effect,
                ts: Date.now()
            });
            lastData = dataString;
        }
    }

    window.onload = () => {
        const saved = JSON.parse(localStorage.getItem('extraPlayers') || '[]');
        saved.forEach(name => createPlayerChip(name));
        const savedName = localStorage.getItem('savedGuestName');
        if(savedName) document.getElementById('guestNameInput').value = savedName;
        const urlParams = new URLSearchParams(window.location.search);
        const inviteRoom = urlParams.get('room');
        if(inviteRoom) {
            document.getElementById('roomIdInput').value = inviteRoom;
            showToast("Sala cargada desde enlace.");
        }
        sonidoMeme.load();
        sonidoEntrada.load();
        const unlock = () => {
            [sonidoMeme, sonidoEntrada].forEach(s => {
                s.play().then(() => { s.pause(); s.currentTime = 0; }).catch(e => {});
            });
            document.removeEventListener('click', unlock);
        };
        document.addEventListener('click', unlock);
    };

    function showToast(msg, type = 'info') {
        const container = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerHTML = `<span>${msg}</span><span class="toast-close" onclick="this.parentElement.remove()">√ó</span>`;
        if(type === 'error') t.style.borderLeftColor = '#ff4444';
        container.appendChild(t);
        setTimeout(() => { if(t.parentElement) { t.classList.add('out'); setTimeout(() => t.remove(), 300); } }, 4000);
    }

    window.startHost = () => {
        isHost = true;
        const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
        roomRef = db.ref('rooms/' + roomId);
        roomRef.remove().then(() => {
            document.getElementById('room-id-val').innerText = roomId;
            document.getElementById('host-controls').classList.remove('hidden');
            document.getElementById('host-actions').classList.remove('hidden');
            showMain();
            
            // Auto-limpieza al desconectar
            roomRef.onDisconnect().remove();

            roomRef.child('guests').on('value', snap => {
                const guests = snap.val() || {};
                const names = Object.values(guests).map(g => g.name);
                updateConnStatus(names);
            });

            // Sincronizaci√≥n inicial
            syncHostData();
        });
    };

    window.onbeforeunload = () => {
        if(isHost && roomRef) roomRef.remove();
        db.goOffline(); // Liberar recursos de Firebase inmediatamente
    };

    window.joinRoom = () => {
        const roomId = document.getElementById('roomIdInput').value.trim().toUpperCase();
        const name = document.getElementById('guestNameInput').value.trim();
        if(!name || !roomId) return showToast("Faltan datos para entrar.");
        localStorage.setItem('savedGuestName', name);
        roomRef = db.ref('rooms/' + roomId);
        roomRef.once('value', snap => {
            if(!snap.exists()) return showToast("La sala no existe.", "error");
            showMain();
            document.getElementById('guest-back').classList.remove('hidden');
            const statusLabel = document.getElementById('conn-status');
            if(statusLabel) statusLabel.innerText = "CONECTANDO...";

            // REPRODUCIR AUDIO AL ENTRAR (SOLO AL INVITADO)
            sonidoEntrada.currentTime = 0;
            sonidoEntrada.play().catch(e => {
                // Si el navegador bloquea, sonar√° al primer clic despu√©s de entrar
                showToast("Haz clic en cualquier parte para activar el audio.");
            });

            myGuestRef = roomRef.child('guests').push();
            myGuestRef.set({ name: name });
            myGuestRef.onDisconnect().remove();
            roomRef.child('guests').on('value', snap => {
                const guests = snap.val() || {};
                const names = Object.values(guests).map(g => g.name);
                updateConnStatus(names);
            });
            roomRef.child('hostData').on('value', snap => {
                const d = snap.val();
                if(!d) return;
                let changed = false;
                if (document.getElementById('players-grid').innerHTML !== d.grid) {
                    document.getElementById('players-grid').innerHTML = d.grid;
                    changed = true;
                }
                if (document.getElementById('sync-area').innerHTML !== d.sync) {
                    document.getElementById('sync-area').innerHTML = d.sync;
                    changed = true;
                }
                if(d.effect) {
                    scrollToTarget();
                    setTimeout(playSpotlight, 100); 
                    sonidoMeme.currentTime = 0;
                    sonidoMeme.play().catch(e => {
                        document.body.onclick = () => { sonidoMeme.play(); document.body.onclick = null; };
                    });
                }
            });
        });
    };

    function updateConnStatus(names) {
        const status = document.getElementById('conn-status');
        if(!status) return;
        status.innerText = names.length > 0 ? `ONLINE: ${names.join(', ')}` : 'SALA VAC√çA';
        status.style.color = names.length > 0 ? 'var(--red)' : '#666';
    }

    function showMain() {
        document.getElementById('view-init').classList.add('hidden');
        document.getElementById('view-main').classList.remove('hidden');
    }

    function scrollToTarget() {
        const target = document.getElementById('final-result');
        if(target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function playSpotlight() {
        const fl = document.getElementById('foco-L'), fr = document.getElementById('foco-R');
        [fl, fr].forEach(f => { f.classList.remove('anim-L', 'anim-R'); void f.offsetWidth; });
        fl.classList.add('anim-L'); fr.classList.add('anim-R');
    }

    window.preRoll = () => {
        if(!isHost) return;
        if (Object.keys(sel).length !== 5) return showToast("¬°Selecciona 5 jugadores!");
        scrollToTarget();
        // Sincronizar con bandera de efecto true
        syncHostData(true);
        setTimeout(() => { playSpotlight(); setTimeout(roll, 600); }, 200);
    };

    window.addNewPlayer = () => {
        if(!isHost) return;
        const name = document.getElementById('newPlayerName').value.trim();
        if(!name || !createPlayerChip(name)) return;
        const saved = JSON.parse(localStorage.getItem('extraPlayers') || '[]');
        saved.push(name);
        localStorage.setItem('extraPlayers', JSON.stringify(saved));
        document.getElementById('newPlayerName').value = '';
        syncHostData();
    };

    function createPlayerChip(name) {
        const safeId = 'c-' + name.replace(/\s+/g, '');
        if(document.getElementById(safeId)) return false;
        const chip = document.createElement('div');
        chip.className = 'chip'; chip.id = safeId; chip.innerText = name.toUpperCase();
        chip.onclick = () => togP(name);
        document.getElementById('players-grid').appendChild(chip);
        return true;
    }

    window.togP = (name) => {
        if(!isHost) return;
        const safeId = 'c-' + name.replace(/\s+/g, '');
        const chip = document.getElementById(safeId);
        if (sel[name]) {
            delete sel[name]; if(chip) chip.classList.remove('active');
            const row = document.getElementById('r-' + safeId); if(row) row.remove();
        } else {
            if (Object.keys(sel).length >= 5) return;
            const prefs = JSON.parse(localStorage.getItem('posPrefs') || '{}');
            const savedPos = prefs[name] || [0,1,2,3,4];
            sel[name] = savedPos; 
            if(chip) chip.classList.add('active');
            const row = document.createElement('div');
            row.className = 'row'; row.id = 'r-' + safeId;
            let btns = POS_LABELS.map((p, i) => {
                const isOn = savedPos.includes(i) ? 'on' : '';
                return `<div class="box ${isOn}" onclick="togPos('${name}',${i})">${p}</div>`;
            }).join('');
            row.innerHTML = `<div class="p-name">${name.toUpperCase()}</div><div class="btns">${btns}</div>`;
            document.getElementById('config-list').appendChild(row);
        }
        document.getElementById('final-result').innerHTML = '<div class="skeleton">ESPERANDO SORTEO...</div>';
        syncHostData();
    };

    window.togPos = (name, i) => {
        if(!isHost) return;
        if (sel[name].includes(i)) {
            if (sel[name].length > 1) sel[name] = sel[name].filter(x => x !== i);
        } else {
            sel[name].push(i);
        }
        const prefs = JSON.parse(localStorage.getItem('posPrefs') || '{}');
        prefs[name] = sel[name];
        localStorage.setItem('posPrefs', JSON.stringify(prefs));
        
        const safeId = 'c-' + name.replace(/\s+/g, '');
        const row = document.getElementById('r-' + safeId);
        if(row) {
            row.querySelector('.btns').innerHTML = POS_LABELS.map((p, idx) => {
                const isOn = sel[name].includes(idx) ? 'on' : '';
                return `<div class="box ${isOn}" onclick="togPos('${name}',${idx})">${p}</div>`;
            }).join('');
        }
        syncHostData();
    };

    window.roll = () => {
        const names = Object.keys(sel);
        if (names.length !== 5) return;
        let res = new Array(5).fill(null);
        
        // Contar cu√°ntos jugadores han solicitado cada posici√≥n (para detectar posiciones "raras")
        const posRequests = new Array(5).fill(0);
        names.forEach(n => sel[n].forEach(pIdx => posRequests[pIdx]++));

        // Ordenar jugadores: primero los que tienen menos opciones (restricci√≥n m√°xima)
        let players = names.map(n => ({
            n, 
            p: [...sel[n]]
        })).sort((a,b) => a.p.length - b.p.length);

        for (let player of players) {
            // Para cada jugador, ordenar sus posiciones preferidas por "rareza" global.
            // Esto evita que un jugador con varias opciones "robe" una posici√≥n muy demandada
            // si tiene disponible una posici√≥n que solo √©l (o pocos m√°s) puede jugar (como el C).
            let options = player.p.sort((a, b) => {
                if (posRequests[a] !== posRequests[b]) return posRequests[a] - posRequests[b];
                return Math.random() - 0.5;
            });

            let found = false;
            for (let pos of options) { 
                if (!res[pos]) { 
                    res[pos] = player.n; 
                    found = true; 
                    break; 
                } 
            }
            if (!found) { 
                // Si no hay ninguna de sus preferidas libres, se le asigna la primera que quede
                for (let i=0; i<5; i++) {
                    if(!res[i]) { 
                        res[i] = player.n; 
                        break; 
                    } 
                }
            }
        }
        showRes(res);
        syncHostData();
    };

    function showRes(res) {
        let textResult = "üèÄ *QUINTETO 2K SYNC* üèÄ\n\n";
        let html = '<div class="result">';
        POS_LABELS.forEach((l, i) => {
            html += `<div class="res-line" style="animation-delay: ${i*0.3}s"><span class="res-pos">${l}</span><span class="res-val">${res[i].toUpperCase()}</span></div>`;
            textResult += `*${l}:* ${res[i].toUpperCase()}\n`;
        });
        window.lastResultText = textResult;
        html += `<div class="res-actions"><button class="btn-copy" onclick="copyToWhatsApp()">COPIAR PARA WHATSAPP</button></div></div>`;
        document.getElementById('final-result').innerHTML = html;
    };

    window.copyToWhatsApp = () => {
        if(!window.lastResultText) return;
        navigator.clipboard.writeText(window.lastResultText);
        showToast("¬°Copiado para WhatsApp!");
    };

    window.resetAll = () => {
        if(!isHost) return;
        sel = {}; document.getElementById('config-list').innerHTML = '';
        document.getElementById('final-result').innerHTML = '<div class="skeleton">ESPERANDO SORTEO...</div>';
        document.querySelectorAll('.chip.active').forEach(c => c.classList.remove('active'));
        syncHostData();
    };

    window.copyId = () => { 
        navigator.clipboard.writeText(document.getElementById('room-id-val').innerText); 
        showToast("ID de sala copiado"); 
    };

    window.copyInviteLink = () => {
        const id = document.getElementById('room-id-val').innerText;
        if(id === '-------') return;
        const link = `${window.location.origin}${window.location.pathname}?room=${id}`;
        navigator.clipboard.writeText(link);
        showToast("¬°Link de invitaci√≥n copiado!");
    };
</script>
</body>
</html>