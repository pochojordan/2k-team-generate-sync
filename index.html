<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2K SYNC - STADIUM ENTRANCE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&display=swap');
        * { box-sizing: border-box; }
        :root { --red: #ff0000; --glow: 0 0 10px rgba(255, 0, 0, 0.5); }
        
        body { 
            margin: 0; font-family: 'Inter', sans-serif; background: #000; color: white; 
            display: flex; justify-content: center; min-height: 100vh; padding: 5px; 
            background: radial-gradient(circle at top, #1a0000 0%, #000 100%);
            overflow-x: hidden; width: 100%;
        }

        .app { width: 100%; max-width: 1000px; position: relative; }
        h1 { font-family: 'Orbitron'; color: var(--red); text-align: center; text-shadow: var(--glow); letter-spacing: 2px; margin: 10px 0; font-size: 1.4rem; }

        /* FOCOS */
        .spotlight { position: fixed; top: 0; width: 40%; height: 100%; background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), #fff, rgba(255,255,255,0.1), transparent); z-index: 100; pointer-events: none; opacity: 0; filter: blur(15px); }
        #foco-L { left: -50%; transform: skewX(-15deg); }
        #foco-R { right: -50%; transform: skewX(15deg); }
        .anim-L { animation: sweepL 1.2s ease-in-out; }
        .anim-R { animation: sweepR 1.2s ease-in-out; }
        @keyframes sweepL { 0% { left: -50%; opacity: 0; } 50% { opacity: 0.6; } 100% { left: 120%; opacity: 0; } }
        @keyframes sweepR { 0% { right: -50%; opacity: 0; } 50% { opacity: 0.6; } 100% { right: 120%; opacity: 0; } }

        /* LAYOUT */
        .main-layout { display: grid; gap: 10px; grid-template-columns: 100%; width: 100%; }
        @media (min-width: 800px) { .main-layout { grid-template-columns: 320px 1fr; } }
        .panel { background: rgba(10, 10, 10, 0.95); border: 1px solid rgba(255,0,0,0.2); border-radius: 10px; padding: 12px; width: 100%; }

        .grid { display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 4px !important; margin-bottom: 12px; }
        .chip { background: #111; border: 1px solid #222; padding: 10px 2px; border-radius: 6px; font-size: 0.6rem; font-weight: 700; color: #555; text-align: center; cursor: pointer; }
        .chip.active { border-color: var(--red); color: white; box-shadow: var(--glow); background: rgba(255,0,0,0.1); }

        .row { display: flex !important; align-items: center; justify-content: space-between; background: #080808; padding: 6px 10px; border-radius: 8px; border: 1px solid #1a1a1a; margin-bottom: 6px; }
        .p-name { font-weight: 700; font-size: 0.65rem; width: 60px; color: #ccc; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .btns { display: flex; gap: 3px; }
        .box { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-weight: 800; border-radius: 4px; background: #1a1a1a; border: 1px solid #333; color: #444; cursor: pointer; }
        .box.on { background: var(--red); color: white; border-color: var(--red); }

        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input { flex: 1; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 6px; font-size: 0.85rem; }
        button { background: var(--red); color: white; border: none; padding: 12px; border-radius: 6px; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; transition: all 0.2s; }
        button:hover { background: #ff3333; transform: translateY(-1px); box-shadow: var(--glow); }
        button:active { transform: translateY(0); }

        .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid #444; color: #ccc; font-size: 0.65rem; }
        .btn-secondary:hover { border-color: var(--red); color: white; background: rgba(255,0,0,0.1); }
        
        .btn-full { width: 100%; margin-top: 5px; }
        
        /* RESULTADO Y ANIMACIÓN INDIVIDUAL */
        #final-result { min-height: 180px; margin-top: 10px; }
        .skeleton { border: 1px dashed #222; border-radius: 10px; height: 180px; display: flex; align-items: center; justify-content: center; color: #222; font-family: 'Orbitron'; font-size: 0.6rem; letter-spacing: 2px; }
        
        .result { padding: 12px; border-radius: 10px; border: 2px solid var(--red); background: rgba(255,0,0,0.1); width: 100%; }
        
        /* Animación para cada línea */
        .res-line { 
            display: flex; justify-content: space-between; padding: 8px 0; 
            border-bottom: 1px solid rgba(255,0,0,0.1);
            opacity: 0;
            animation: fadeInRight 0.5s ease-out forwards;
        }
        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .res-pos { color: var(--red); font-family: 'Orbitron'; font-size: 0.7rem; }
        .res-val { font-weight: 700; font-size: 0.95rem; }
        .hidden { display: none !important; }

        /* TOAST NOTIFICATIONS */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { 
            background: rgba(10, 10, 10, 0.9); border-left: 4px solid var(--red); color: white; 
            padding: 15px 25px; border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 0.8rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            opacity: 0; transform: translateX(50px); animation: toastIn 0.3s ease forwards;
            pointer-events: auto; min-width: 250px; display: flex; align-items: center; justify-content: space-between;
        }
        @keyframes toastIn { to { opacity: 1; transform: translateX(0); } }
        .toast.out { animation: toastOut 0.3s ease forwards; }
        @keyframes toastOut { to { opacity: 0; transform: translateX(50px); } }
        .toast-close { cursor: pointer; color: #555; font-size: 1.2rem; margin-left: 15px; }
        .toast-close:hover { color: var(--red); }
    </style>
</head>
<body>

<div class="spotlight" id="foco-L"></div>
<div class="spotlight" id="foco-R"></div>
<div id="toast-container"></div>

<div class="app">
    <h1>2K SYNC</h1>
    <div id="view-init" class="panel" style="max-width: 360px; margin: 0 auto;">
        <button class="btn-full" onclick="startHost()">CREAR SALA</button>
        <div style="margin-top: 15px; border-top: 1px solid #222; padding-top: 15px;">
            <input type="text" id="guestNameInput" placeholder="Tu nombre..." style="margin-bottom: 5px; width: 100%;">
            <div class="input-group">
                <input type="text" id="roomIdInput" placeholder="ID SALA...">
                <button onclick="joinRoom()" class="btn-secondary">UNIRSE</button>
            </div>
        </div>
    </div>

    <div id="view-main" class="hidden">
        <div class="main-layout">
            <div class="panel">
                <div id="host-controls" class="hidden">
                    <div id="share-card" style="background:#0a0a0a; border:1px solid var(--red); border-radius:6px; padding:8px; text-align:center; cursor:pointer; margin-bottom:10px;" onclick="copyId()">
                        <span style="font-size:0.5rem; color:#666; display:block;">ID SALA (COPIAR)</span>
                        <div id="room-id-val" style="font-family:'Orbitron'; font-size:0.8rem;">-------</div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="newPlayerName" placeholder="Nombre...">
                        <button onclick="addNewPlayer()">ADD</button>
                    </div>
                </div>
                <div class="grid" id="players-grid">
                    <div class="chip" id="c-Airam" onclick="togP('Airam')">AIRAM</div>
                    <div class="chip" id="c-Pocho" onclick="togP('Pocho')">POCHO</div>
                    <div class="chip" id="c-Isra" onclick="togP('Isra')">ISRA</div>
                    <div class="chip" id="c-Messi" onclick="togP('Messi')">MESSI</div>
                    <div class="chip" id="c-Triodo" onclick="togP('Triodo')">TRIODO</div>
                    <div class="chip" id="c-Salva" onclick="togP('Salva')">SALVA</div>
                    <div class="chip" id="c-Eu" onclick="togP('Eu')">EU</div>
                    <div class="chip" id="c-Fer" onclick="togP('Fer')">FER</div>
                </div>
                <div id="host-actions" class="hidden">
                    <button class="btn-full" onclick="preRoll()">GENERAR QUINTETO</button>
                    <button class="btn-full btn-secondary" onclick="resetAll()">REINICIAR</button>
                </div>
                <button id="guest-back" class="btn-full btn-secondary hidden" style="margin-top:10px;" onclick="location.reload()">← SALIR</button>
            </div>

            <div class="panel" id="sync-area">
                <h2 style="font-family:'Orbitron'; font-size:0.6rem; color:#333; margin:0 0 10px 0; border-bottom:1px solid #111; padding-bottom:5px; display:flex; justify-content:space-between;">
                    SALA DE SORTEO
                    <span id="conn-status" style="color: #444; font-size: 0.5rem; text-align: right;">DISPONIBLE</span>
                </h2>
                <div id="config-list"></div>
                <div id="final-result">
                    <div class="skeleton">ESPERANDO SORTEO...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let peer, conns = [], sel = {}, isHost = false, lastHtml = "";
    const POS_LABELS = ["PG", "SG", "LK", "PF", "C"];
    const sonidoMeme = new Audio('oh-my-god-meme.mp3');

    window.onload = () => {
        const saved = JSON.parse(localStorage.getItem('extraPlayers') || '[]');
        saved.forEach(name => createPlayerChip(name));
        
        // Cargar audio y preparar error
        sonidoMeme.load();
        sonidoMeme.onerror = () => showToast("Error: No se pudo cargar el sonido.", "error");
        
        // Intentar desbloquear en el primer clic global
        const unlock = () => {
            sonidoMeme.play().then(() => {
                sonidoMeme.pause();
                sonidoMeme.currentTime = 0;
                console.log("Audio desbloqueado");
            }).catch(e => console.log("Audio bloqueado aún"));
            document.removeEventListener('click', unlock);
        };
        document.addEventListener('click', unlock);
    };

    function showToast(msg, type = 'info') {
        const container = document.getElementById('toast-container');
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerHTML = `<span>${msg}</span><span class="toast-close" onclick="this.parentElement.remove()">×</span>`;
        if(type === 'error') t.style.borderLeftColor = '#ff4444';
        container.appendChild(t);
        setTimeout(() => { t.classList.add('out'); setTimeout(() => t.remove(), 300); }, 4000);
    }

    const PEER_CONFIG = {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' },
                { url: 'stun:stun2.l.google.com:19302' },
            ]
        }
    };

    window.startHost = () => {
        isHost = true;
        peer = new Peer(PEER_CONFIG);
        peer.on('open', id => {
            document.getElementById('room-id-val').innerText = id;
            document.getElementById('host-controls').classList.remove('hidden');
            document.getElementById('host-actions').classList.remove('hidden');
            showMain();
        });
        peer.on('error', err => {
            console.error('Peer error:', err);
            showToast("Error en la sala: " + err.type, "error");
        });
        peer.on('connection', c => {
            console.log("Nueva conexión entrante");
            c.on('data', d => {
                if (d.type === 'HELO') {
                    c.metadata = { name: d.name };
                    updateConnStatus();
                }
            });
            conns.push(c);
        });

        // Loop de sincronización único para todos los clientes
        setInterval(() => {
            if (conns.length > 0) {
                const currentHtml = document.getElementById('sync-area').innerHTML;
                const currentChips = document.getElementById('players-grid').innerHTML;
                
                if(currentHtml + currentChips !== lastHtml || window.triggerEffect) {
                    const data = { html: currentHtml, chips: currentChips, effect: window.triggerEffect };
                    // Enviar a todos y limpiar desconectados
                    let changed = false;
                    conns = conns.filter(c => {
                        if (c.open) {
                            c.send(data);
                            return true;
                        }
                        changed = true;
                        return false;
                    });
                    if(changed) updateConnStatus();
                    lastHtml = currentHtml + currentChips;
                    window.triggerEffect = false;
                }
            }
        }, 800);
    };

    function updateConnStatus() {
        const status = document.getElementById('conn-status');
        if(!status) return;
        const names = conns.filter(c => c.open && c.metadata).map(c => c.metadata.name);
        const label = names.length > 0 ? `ONLINE: ${names.join(', ')}` : (conns.length > 0 ? `CONECTANDO...` : 'VACIÓ');
        
        status.innerText = label;
        status.style.color = names.length > 0 ? 'var(--red)' : '#444';

        // Enviar lista de nombres a todos los invitados
        conns.forEach(c => {
            if (c.open) c.send({ type: 'NAMES', list: names });
        });
    }

    let retryCount = 0;
    const MAX_RETRIES = 5;

    window.joinRoom = () => {
        const id = document.getElementById('roomIdInput').value.trim();
        const name = document.getElementById('guestNameInput').value.trim();
        
        if(!name) return showToast("Por favor, introduce tu nombre.");
        if(!id) return showToast("Introduce el ID de la sala.");
        
        retryCount = 0;
        attemptConnection(id, name);
    };

    function attemptConnection(id, name) {
        if(peer) peer.destroy();
        peer = new Peer(PEER_CONFIG);

        peer.on('open', () => {
            const conn = peer.connect(id, { reliable: true });
            showMain();
            document.getElementById('guest-back').classList.remove('hidden');
            
            const connTimeout = setTimeout(() => {
                if(!conn.open) {
                    console.log("Timeout de conexión, reintentando...");
                    handleRetry(id, name);
                }
            }, 5000);

            conn.on('open', () => {
                clearTimeout(connTimeout);
                retryCount = 0;
                console.log("Conectado al host");
                conn.send({ type: 'HELO', name: name });
                const status = document.getElementById('conn-status');
                if(status) { status.innerText = `CONECTADO COMO: ${name.toUpperCase()}`; status.style.color = 'var(--red)'; }
            });

            conn.on('data', d => { 
                if (d.type === 'NAMES') {
                    const status = document.getElementById('conn-status');
                    if(status) { 
                        status.innerText = `ONLINE: ${d.list.join(', ')}`; 
                        status.style.color = 'var(--red)'; 
                    }
                    return;
                }
                if (document.getElementById('sync-area').innerHTML !== d.html) {
                    document.getElementById('sync-area').innerHTML = d.html;
                }
                if (document.getElementById('players-grid').innerHTML !== d.chips) {
                    document.getElementById('players-grid').innerHTML = d.chips;
                }
                if(d.effect) {
                    scrollToTarget();
                    setTimeout(playSpotlight, 100); 
                    sonidoMeme.currentTime = 0;
                    sonidoMeme.volume = 1.0;
                    sonidoMeme.play().catch(e => {
                        document.body.onclick = () => { sonidoMeme.play(); document.body.onclick = null; };
                    });
                }
            });

            conn.on('close', () => {
                console.log("Conexión perdida, intentando reconectar...");
                handleRetry(id, name);
            });

            conn.on('error', (err) => {
                console.error('Conn error:', err);
                handleRetry(id, name);
            });
        });

        peer.on('error', err => {
            console.error('Peer error:', err);
            if(err.type === 'peer-unavailable') {
                showToast("Sala no encontrada. Revisa el ID.", "error");
            } else {
                handleRetry(id, name);
            }
        });
    }

    function handleRetry(id, name) {
        if (retryCount < MAX_RETRIES) {
            retryCount++;
            const status = document.getElementById('conn-status');
            if(status) status.innerText = `RECONECTANDO (${retryCount}/${MAX_RETRIES})...`;
            setTimeout(() => attemptConnection(id, name), 2000);
        } else {
            showToast("No se pudo conectar tras varios intentos.", "error");
            const status = document.getElementById('conn-status');
            if(status) status.innerText = `ERROR DE CONEXIÓN`;
        }
    }

    function showMain() {
        document.getElementById('view-init').classList.add('hidden');
        document.getElementById('view-main').classList.remove('hidden');
    }

    function scrollToTarget() {
        const target = document.getElementById('final-result');
        if(target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function playSpotlight() {
        const fl = document.getElementById('foco-L');
        const fr = document.getElementById('foco-R');
        [fl, fr].forEach(f => { f.classList.remove('anim-L', 'anim-R'); void f.offsetWidth; });
        fl.classList.add('anim-L'); fr.classList.add('anim-R');
    }

    window.preRoll = () => {
        if(!isHost) return;
        if (Object.keys(sel).length !== 5) return showToast("¡Selecciona 5 jugadores!");
        scrollToTarget();
        window.triggerEffect = true;
        setTimeout(() => {
            playSpotlight();
            setTimeout(roll, 600);
        }, 200);
    };

    window.addNewPlayer = () => {
        if(!isHost) return;
        const name = document.getElementById('newPlayerName').value.trim();
        if(!name || !createPlayerChip(name)) return;
        const saved = JSON.parse(localStorage.getItem('extraPlayers') || '[]');
        saved.push(name);
        localStorage.setItem('extraPlayers', JSON.stringify(saved));
        document.getElementById('newPlayerName').value = '';
    };

    function createPlayerChip(name) {
        const safeId = 'c-' + name.replace(/\s+/g, '');
        if(document.getElementById(safeId)) return false;
        const chip = document.createElement('div');
        chip.className = 'chip'; chip.id = safeId; chip.innerText = name.toUpperCase();
        chip.onclick = () => togP(name);
        document.getElementById('players-grid').appendChild(chip);
        return true;
    }

    window.togP = (name) => {
        if(!isHost) return;
        const safeId = 'c-' + name.replace(/\s+/g, '');
        const chip = document.getElementById(safeId);
        if (sel[name]) {
            delete sel[name]; chip.classList.remove('active');
            const row = document.getElementById('r-' + safeId); if(row) row.remove();
        } else {
            if (Object.keys(sel).length >= 5) return;
            sel[name] = [0,1,2,3,4]; chip.classList.add('active');
            const row = document.createElement('div');
            row.className = 'row'; row.id = 'r-' + safeId;
            let btns = POS_LABELS.map((p, i) => `<div class="box on" id="b-${safeId}-${i}" onclick="togPos('${name}',${i})">${p}</div>`).join('');
            row.innerHTML = `<div class="p-name">${name.toUpperCase()}</div><div class="btns">${btns}</div>`;
            document.getElementById('config-list').appendChild(row);
        }
        document.getElementById('final-result').innerHTML = '<div class="skeleton">ESPERANDO SORTEO...</div>';
    };

    window.togPos = (name, i) => {
        if(!isHost) return;
        const safeId = 'c-' + name.replace(/\s+/g, '');
        const btn = document.getElementById(`b-${safeId}-${i}`);
        if (sel[name].includes(i)) {
            if (sel[name].length > 1) { sel[name] = sel[name].filter(x => x !== i); btn.classList.remove('on'); }
        } else { sel[name].push(i); btn.classList.add('on'); }
    };

    window.roll = () => {
    const names = Object.keys(sel);
    let res = new Array(5).fill(null);
    let players = names.map(n => ({n, p: [...sel[n]]})).sort((a,b) => a.p.length - b.p.length);
    
    for (let p of players) {
        let options = p.p.sort(() => Math.random() - 0.5);
        let found = false;
        for (let pos of options) { if (!res[pos]) { res[pos] = p.n; found = true; break; } }
        if (!found) { for (let i=0; i<5; i++) if(!res[i]) { res[i] = p.n; break; } }
    }

    // --- EFECTO DE SONIDO ---
    sonidoMeme.currentTime = 0; 
    sonidoMeme.volume = 1.0;
    const playPromise = sonidoMeme.play();
    if (playPromise !== undefined) {
        playPromise.catch(e => {
            console.log("Error de reproducción:", e);
            // Intentar una última vez si hubo interacción
            setTimeout(() => { sonidoMeme.play().catch(()=>{}); }, 50);
        });
    }
    // ------------------------

    let html = '<div class="result">';
    POS_LABELS.forEach((l, i) => {
        const delay = i * 0.3; 
        html += `<div class="res-line" style="animation-delay: ${delay}s">
                    <span class="res-pos">${l}</span>
                    <span class="res-val">${res[i].toUpperCase()}</span>
                 </div>`;
    });
    document.getElementById('final-result').innerHTML = html + '</div>';
};

    window.resetAll = () => {
        if(!isHost) return;
        sel = {}; document.getElementById('config-list').innerHTML = '';
        document.getElementById('final-result').innerHTML = '<div class="skeleton">ESPERANDO SORTEO...</div>';
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    };

    window.copyId = () => { 
        navigator.clipboard.writeText(document.getElementById('room-id-val').innerText); 
        showToast("ID de sala copiado"); 
    };
</script>
</body>
</html>