<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2K SYNC - STADIUM ENTRANCE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;700&display=swap');
        * { box-sizing: border-box; }
        :root { --red: #ff0000; --glow: 0 0 10px rgba(255, 0, 0, 0.5); }
        
        body { 
            margin: 0; font-family: 'Inter', sans-serif; background: #000; color: white; 
            display: flex; justify-content: center; min-height: 100vh; padding: 5px; 
            background: radial-gradient(circle at top, #1a0000 0%, #000 100%);
            overflow-x: hidden; width: 100%;
        }

        .app { width: 100%; max-width: 1000px; position: relative; }
        h1 { font-family: 'Orbitron'; color: var(--red); text-align: center; text-shadow: var(--glow); letter-spacing: 2px; margin: 10px 0; font-size: 1.4rem; }

        /* FOCOS */
        .spotlight { position: fixed; top: 0; width: 40%; height: 100%; background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), #fff, rgba(255,255,255,0.1), transparent); z-index: 100; pointer-events: none; opacity: 0; filter: blur(15px); }
        #foco-L { left: -50%; transform: skewX(-15deg); }
        #foco-R { right: -50%; transform: skewX(15deg); }
        .anim-L { animation: sweepL 1.2s ease-in-out; }
        .anim-R { animation: sweepR 1.2s ease-in-out; }
        @keyframes sweepL { 0% { left: -50%; opacity: 0; } 50% { opacity: 0.6; } 100% { left: 120%; opacity: 0; } }
        @keyframes sweepR { 0% { right: -50%; opacity: 0; } 50% { opacity: 0.6; } 100% { right: 120%; opacity: 0; } }

        /* LAYOUT */
        .main-layout { display: grid; gap: 10px; grid-template-columns: 100%; width: 100%; }
        @media (min-width: 800px) { .main-layout { grid-template-columns: 320px 1fr; } }
        .panel { background: rgba(10, 10, 10, 0.95); border: 1px solid rgba(255,0,0,0.2); border-radius: 10px; padding: 12px; width: 100%; }

        .grid { display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 4px !important; margin-bottom: 12px; }
        .chip { background: #111; border: 1px solid #222; padding: 10px 2px; border-radius: 6px; font-size: 0.6rem; font-weight: 700; color: #555; text-align: center; cursor: pointer; }
        .chip.active { border-color: var(--red); color: white; box-shadow: var(--glow); background: rgba(255,0,0,0.1); }

        .row { display: flex !important; align-items: center; justify-content: space-between; background: #080808; padding: 6px 10px; border-radius: 8px; border: 1px solid #1a1a1a; margin-bottom: 6px; }
        .p-name { font-weight: 700; font-size: 0.65rem; width: 60px; color: #ccc; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .btns { display: flex; gap: 3px; }
        .box { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 0.55rem; font-weight: 800; border-radius: 4px; background: #1a1a1a; border: 1px solid #333; color: #444; cursor: pointer; }
        .box.on { background: var(--red); color: white; border-color: var(--red); }

        .input-group { display: flex; gap: 5px; margin-bottom: 10px; }
        input { flex: 1; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 6px; font-size: 0.85rem; }
        button { background: var(--red); color: white; border: none; padding: 12px; border-radius: 6px; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; }
        .btn-full { width: 100%; margin-top: 5px; }
        
        /* RESULTADO Y ANIMACI√ìN INDIVIDUAL */
        #final-result { min-height: 180px; margin-top: 10px; }
        .skeleton { border: 1px dashed #222; border-radius: 10px; height: 180px; display: flex; align-items: center; justify-content: center; color: #222; font-family: 'Orbitron'; font-size: 0.6rem; letter-spacing: 2px; }
        
        .result { padding: 12px; border-radius: 10px; border: 2px solid var(--red); background: rgba(255,0,0,0.1); width: 100%; }
        
        /* Animaci√≥n para cada l√≠nea */
        .res-line { 
            display: flex; justify-content: space-between; padding: 8px 0; 
            border-bottom: 1px solid rgba(255,0,0,0.1);
            opacity: 0;
            animation: fadeInRight 0.5s ease-out forwards;
        }
        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .res-pos { color: var(--red); font-family: 'Orbitron'; font-size: 0.7rem; }
        .res-val { font-weight: 700; font-size: 0.95rem; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="spotlight" id="foco-L"></div>
<div class="spotlight" id="foco-R"></div>

<div class="app">
    <h1 style="cursor:pointer;" onclick="sonidoMeme.play().catch(e=>alert('Error: '+e.message))">2K SYNC <span style="font-size:0.8rem; opacity:0.5;">üîä</span></h1>
    
    <div id="view-init" class="panel" style="max-width: 360px; margin: 0 auto;">
        <button class="btn-full" onclick="startHost()">CREAR SALA</button>
        <div class="input-group" style="margin-top: 15px;">
            <input type="text" id="roomIdInput" placeholder="ID SALA...">
            <button onclick="joinRoom()" style="background: #222;">UNIRSE</button>
        </div>
    </div>

    <div id="view-main" class="hidden">
        <div class="main-layout">
            <div class="panel">
                <div id="host-controls" class="hidden">
                    <div id="share-card" style="background:#0a0a0a; border:1px solid var(--red); border-radius:6px; padding:8px; text-align:center; cursor:pointer; margin-bottom:10px;" onclick="copyId()">
                        <span style="font-size:0.5rem; color:#666; display:block;">ID SALA (COPIAR)</span>
                        <div id="room-id-val" style="font-family:'Orbitron'; font-size:0.8rem;">-------</div>
                    </div>
                    <div class="input-group">
                        <input type="text" id="newPlayerName" placeholder="Nombre...">
                        <button onclick="addNewPlayer()">ADD</button>
                    </div>
                </div>
                <div class="grid" id="players-grid">
                    <div class="chip" id="c-Airam" onclick="togP('Airam')">AIRAM</div>
                    <div class="chip" id="c-Pocho" onclick="togP('Pocho')">POCHO</div>
                    <div class="chip" id="c-Isra" onclick="togP('Isra')">ISRA</div>
                    <div class="chip" id="c-Messi" onclick="togP('Messi')">MESSI</div>
                    <div class="chip" id="c-Triodo" onclick="togP('Triodo')">TRIODO</div>
                    <div class="chip" id="c-Salva" onclick="togP('Salva')">SALVA</div>
                    <div class="chip" id="c-Eu" onclick="togP('Eu')">EU</div>
                    <div class="chip" id="c-Fer" onclick="togP('Fer')">FER</div>
                </div>
                <div id="host-actions" class="hidden">
                    <button class="btn-full" onclick="preRoll()">GENERAR QUINTETO</button>
                    <button class="btn-full" style="background:transparent; border:1px solid #222; color:#444; font-size:0.6rem;" onclick="resetAll()">REINICIAR</button>
                </div>
                <button id="guest-back" class="btn-full hidden" style="background:transparent; border:1px solid #222; color:#444; font-size:0.6rem; margin-top:10px;" onclick="location.reload()">‚Üê SALIR</button>
            </div>

            <div class="panel" id="sync-area">
                <h2 style="font-family:'Orbitron'; font-size:0.6rem; color:#333; margin:0 0 10px 0; border-bottom:1px solid #111; padding-bottom:5px;">SALA DE SORTEO</h2>
                <div id="config-list"></div>
                <div id="final-result">
                    <div class="skeleton">ESPERANDO SORTEO...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let peer, conn, sel = {}, isHost = false, lastHtml = "";
    const POS_LABELS = ["PG", "SG", "LK", "PF", "C"];
    const sonidoMeme = new Audio('oh-my-god-meme.mp3');

    window.onload = () => {
        const saved = JSON.parse(localStorage.getItem('extraPlayers') || '[]');
        saved.forEach(name => createPlayerChip(name));
        
        // Cargar audio y preparar error
        sonidoMeme.load();
        sonidoMeme.onerror = () => alert("Error: No se pudo cargar 'oh-my-god-meme.mp3'. Aseg√∫rate de que el archivo existe en la carpeta.");
        
        // Intentar desbloquear en el primer clic global
        const unlock = () => {
            sonidoMeme.play().then(() => {
                sonidoMeme.pause();
                sonidoMeme.currentTime = 0;
                console.log("Audio desbloqueado");
            }).catch(e => console.log("Audio bloqueado a√∫n"));
            document.removeEventListener('click', unlock);
        };
        document.addEventListener('click', unlock);
    };

    window.startHost = () => {
        isHost = true;
        peer = new Peer();
        peer.on('open', id => {
            document.getElementById('room-id-val').innerText = id;
            document.getElementById('host-controls').classList.remove('hidden');
            document.getElementById('host-actions').classList.remove('hidden');
            showMain();
        });
        peer.on('connection', c => {
            conn = c;
            setInterval(() => { 
                if(conn.open) {
                    const currentHtml = document.getElementById('sync-area').innerHTML;
                    const currentChips = document.getElementById('players-grid').innerHTML;
                    if(currentHtml + currentChips !== lastHtml || window.triggerEffect) {
                        conn.send({ html: currentHtml, chips: currentChips, effect: window.triggerEffect });
                        lastHtml = currentHtml + currentChips;
                        window.triggerEffect = false;
                    }
                }
            }, 600);
        });
    };

    window.joinRoom = () => {
        const id = document.getElementById('roomIdInput').value.trim();
        if(!id) return;
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(id);
            showMain();
            document.getElementById('guest-back').classList.remove('hidden');
            conn.on('data', d => { 
                if (document.getElementById('sync-area').innerHTML !== d.html) {
                    document.getElementById('sync-area').innerHTML = d.html;
                }
                if (document.getElementById('players-grid').innerHTML !== d.chips) {
                    document.getElementById('players-grid').innerHTML = d.chips;
                }
                if(d.effect) {
                    scrollToTarget();
                    setTimeout(playSpotlight, 100); 
                    // Play sound for guest
                    sonidoMeme.currentTime = 0;
                    sonidoMeme.volume = 1.0;
                    sonidoMeme.play().catch(e => {
                        console.log("Audio guest blocked", e);
                        // Si falla, intentamos que el usuario haga clic para o√≠rlo
                        document.body.onclick = () => { sonidoMeme.play(); document.body.onclick = null; };
                    });
                }
            });
        });
    };

    function showMain() {
        document.getElementById('view-init').classList.add('hidden');
        document.getElementById('view-main').classList.remove('hidden');
    }

    function scrollToTarget() {
        const target = document.getElementById('final-result');
        if(target) target.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function playSpotlight() {
        const fl = document.getElementById('foco-L');
        const fr = document.getElementById('foco-R');
        [fl, fr].forEach(f => { f.classList.remove('anim-L', 'anim-R'); void f.offsetWidth; });
        fl.classList.add('anim-L'); fr.classList.add('anim-R');
    }

    window.preRoll = () => {
        if (Object.keys(sel).length !== 5) return alert("Selecciona 5");
        scrollToTarget();
        window.triggerEffect = true;
        setTimeout(() => {
            playSpotlight();
            setTimeout(roll, 600);
        }, 200);
    };

    window.addNewPlayer = () => {
        const name = document.getElementById('newPlayerName').value.trim();
        if(!name || !createPlayerChip(name)) return;
        const saved = JSON.parse(localStorage.getItem('extraPlayers') || '[]');
        saved.push(name);
        localStorage.setItem('extraPlayers', JSON.stringify(saved));
        document.getElementById('newPlayerName').value = '';
    };

    function createPlayerChip(name) {
        const safeId = 'c-' + name.replace(/\s+/g, '');
        if(document.getElementById(safeId)) return false;
        const chip = document.createElement('div');
        chip.className = 'chip'; chip.id = safeId; chip.innerText = name.toUpperCase();
        chip.onclick = () => togP(name);
        document.getElementById('players-grid').appendChild(chip);
        return true;
    }

    window.togP = (name) => {
        if(!isHost) return;
        const safeId = 'c-' + name.replace(/\s+/g, '');
        const chip = document.getElementById(safeId);
        if (sel[name]) {
            delete sel[name]; chip.classList.remove('active');
            const row = document.getElementById('r-' + safeId); if(row) row.remove();
        } else {
            if (Object.keys(sel).length >= 5) return;
            sel[name] = [0,1,2,3,4]; chip.classList.add('active');
            const row = document.createElement('div');
            row.className = 'row'; row.id = 'r-' + safeId;
            let btns = POS_LABELS.map((p, i) => `<div class="box on" id="b-${safeId}-${i}" onclick="togPos('${name}',${i})">${p}</div>`).join('');
            row.innerHTML = `<div class="p-name">${name.toUpperCase()}</div><div class="btns">${btns}</div>`;
            document.getElementById('config-list').appendChild(row);
        }
        document.getElementById('final-result').innerHTML = '<div class="skeleton">ESPERANDO SORTEO...</div>';
    };

    window.togPos = (name, i) => {
        if(!isHost) return;
        const safeId = 'c-' + name.replace(/\s+/g, '');
        const btn = document.getElementById(`b-${safeId}-${i}`);
        if (sel[name].includes(i)) {
            if (sel[name].length > 1) { sel[name] = sel[name].filter(x => x !== i); btn.classList.remove('on'); }
        } else { sel[name].push(i); btn.classList.add('on'); }
    };

    window.roll = () => {
    const names = Object.keys(sel);
    let res = new Array(5).fill(null);
    let players = names.map(n => ({n, p: [...sel[n]]})).sort((a,b) => a.p.length - b.p.length);
    
    for (let p of players) {
        let options = p.p.sort(() => Math.random() - 0.5);
        let found = false;
        for (let pos of options) { if (!res[pos]) { res[pos] = p.n; found = true; break; } }
        if (!found) { for (let i=0; i<5; i++) if(!res[i]) { res[i] = p.n; break; } }
    }

    // --- EFECTO DE SONIDO ---
    sonidoMeme.currentTime = 0; 
    sonidoMeme.volume = 1.0;
    const playPromise = sonidoMeme.play();
    if (playPromise !== undefined) {
        playPromise.catch(e => {
            console.log("Error de reproducci√≥n:", e);
            // Intentar una √∫ltima vez si hubo interacci√≥n
            setTimeout(() => { sonidoMeme.play().catch(()=>{}); }, 50);
        });
    }
    // ------------------------

    let html = '<div class="result">';
    POS_LABELS.forEach((l, i) => {
        const delay = i * 0.3; 
        html += `<div class="res-line" style="animation-delay: ${delay}s">
                    <span class="res-pos">${l}</span>
                    <span class="res-val">${res[i].toUpperCase()}</span>
                 </div>`;
    });
    document.getElementById('final-result').innerHTML = html + '</div>';
};

    window.resetAll = () => {
        sel = {}; document.getElementById('config-list').innerHTML = '';
        document.getElementById('final-result').innerHTML = '<div class="skeleton">ESPERANDO SORTEO...</div>';
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    };

    window.copyId = () => { navigator.clipboard.writeText(document.getElementById('room-id-val').innerText); alert("ID Copiado"); };
</script>
</body>
</html>